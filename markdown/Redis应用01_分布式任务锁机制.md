# Redis åˆ†å¸ƒå¼ä»»åŠ¡é”æœºåˆ¶

## ä¸šåŠ¡åœºæ™¯

è§†é¢‘å¹³å°ä¸­ï¼Œç”¨æˆ·ä¸Šä¼ è§†é¢‘åéœ€è¦è¿›è¡Œè½¬ç å¤„ç†ã€‚è½¬ç æ˜¯ä¸€ä¸ªè€—æ—¶çš„å¼‚æ­¥ä»»åŠ¡ï¼Œç”± Celery Worker æ‰§è¡Œã€‚

**é—®é¢˜**ï¼šå¦‚æœæœ‰å¤šä¸ª Worker åŒæ—¶å¤„ç†åŒä¸€ä¸ªè§†é¢‘ï¼Œä¼šå¯¼è‡´ï¼š
- é‡å¤è½¬ç ï¼Œæµªè´¹æœåŠ¡å™¨èµ„æº
- ç”Ÿæˆå¤šä»½ç›¸åŒçš„æ–‡ä»¶ï¼Œå ç”¨ç£ç›˜ç©ºé—´
- å¯èƒ½äº§ç”Ÿæ–‡ä»¶å†²çªï¼Œå¯¼è‡´è½¬ç å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”ï¼Œç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ª Worker èƒ½å¤„ç†æŸä¸ªè§†é¢‘ã€‚

## æ ¸å¿ƒåŸç†

### Redis SETNX å‘½ä»¤

SETNX = SET if Not eXistsï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™è®¾ç½®ï¼‰

```redis
SETNX key value
```

- å¦‚æœ key ä¸å­˜åœ¨ï¼Œè®¾ç½®æˆåŠŸï¼Œè¿”å› 1
- å¦‚æœ key å·²å­˜åœ¨ï¼Œè®¾ç½®å¤±è´¥ï¼Œè¿”å› 0

è¿™æ˜¯ä¸€ä¸ª**åŸå­æ“ä½œ**ï¼Œå¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶æ‰§è¡Œæ—¶ï¼Œåªæœ‰ä¸€ä¸ªèƒ½æˆåŠŸã€‚

### Django Cache å°è£…

Django çš„ `cache.add()` æ–¹æ³•åº•å±‚ä½¿ç”¨ Redis çš„ SETNXï¼š

```python
from django.core.cache import cache

# å°è¯•è·å–é”
success = cache.add('lock_key', 'locked', timeout=3600)
# success = True  è¡¨ç¤ºè·å–é”æˆåŠŸ
# success = False è¡¨ç¤ºé”å·²è¢«å ç”¨
```

## ä»£ç å®ç°

### 1. é”çš„ Key è®¾è®¡

```python
def get_video_lock_key(video_id):
    """ç”Ÿæˆè§†é¢‘å¤„ç†é”çš„ key"""
    return f"video_processing_lock:{video_id}"
```

**è®¾è®¡è¦ç‚¹**ï¼š
- ä½¿ç”¨å‰ç¼€ `video_processing_lock:` ä¾¿äºè¯†åˆ«å’Œç®¡ç†
- ä½¿ç”¨ `video_id` ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œä¸åŒè§†é¢‘çš„é”äº’ä¸å½±å“

### 2. è·å–é”

```python
def acquire_video_lock(video_id, timeout=3600):
    """
    è·å–è§†é¢‘å¤„ç†é”ï¼ˆä½¿ç”¨ Redisï¼‰
    timeout: é”çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤1å°æ—¶
    è¿”å›: True å¦‚æœè·å–æˆåŠŸï¼ŒFalse å¦‚æœå·²è¢«é”å®š
    """
    lock_key = get_video_lock_key(video_id)
    # ä½¿ç”¨ Redis çš„ SETNX åŸå­æ“ä½œ
    # add() åªåœ¨ key ä¸å­˜åœ¨æ—¶è®¾ç½®ï¼Œè¿”å› Trueï¼›å¦‚æœ key å·²å­˜åœ¨ï¼Œè¿”å› False
    return cache.add(lock_key, "locked", timeout)
```

**å…³é”®ç‚¹**ï¼š
- `timeout` å‚æ•°è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”
- å¦‚æœ Worker å´©æºƒï¼Œé”ä¼šåœ¨è¶…æ—¶åè‡ªåŠ¨é‡Šæ”¾
- è¿”å›å¸ƒå°”å€¼ï¼Œæ–¹ä¾¿åˆ¤æ–­æ˜¯å¦è·å–æˆåŠŸ

### 3. é‡Šæ”¾é”

```python
def release_video_lock(video_id):
    """é‡Šæ”¾è§†é¢‘å¤„ç†é”"""
    lock_key = get_video_lock_key(video_id)
    cache.delete(lock_key)
```

**æ³¨æ„**ï¼š
- å¤„ç†å®Œæˆåå¿…é¡»é‡Šæ”¾é”ï¼Œå¦åˆ™å…¶ä»– Worker æ— æ³•å¤„ç†
- ä½¿ç”¨ `try...finally` ç¡®ä¿é”ä¸€å®šä¼šè¢«é‡Šæ”¾

### 4. æ£€æŸ¥é”çŠ¶æ€

```python
def is_video_locked(video_id):
    """æ£€æŸ¥è§†é¢‘æ˜¯å¦æ­£åœ¨è¢«å¤„ç†"""
    lock_key = get_video_lock_key(video_id)
    return cache.get(lock_key) is not None
```

**ç”¨é€”**ï¼š
- åœ¨è§¦å‘ä»»åŠ¡å‰æ£€æŸ¥æ˜¯å¦å·²æœ‰ä»»åŠ¡åœ¨å¤„ç†
- é¿å…é‡å¤æäº¤ä»»åŠ¡åˆ°é˜Ÿåˆ—

## åœ¨ Celery ä»»åŠ¡ä¸­ä½¿ç”¨

### å®Œæ•´æµç¨‹

```python
@shared_task(bind=True, max_retries=3, default_retry_delay=60)
def process_video(self, video_id):
    """å¤„ç†è§†é¢‘æ–‡ä»¶ï¼Œç”ŸæˆHLSæ ¼å¼ã€ç¼©ç•¥å›¾ç­‰"""
    
    # ç¬¬ä¸€å±‚é˜²æŠ¤ï¼šRedis åˆ†å¸ƒå¼é”
    if not acquire_video_lock(video_id, timeout=7200):  # 2å°æ—¶è¶…æ—¶
        logger.warning(f"è§†é¢‘ {video_id} æ­£åœ¨è¢«å…¶ä»–ä»»åŠ¡å¤„ç†ï¼ˆRedisé”ï¼‰ï¼Œè·³è¿‡")
        return {"status": "skipped", "reason": "already_processing"}
    
    try:
        # ç¬¬äºŒå±‚é˜²æŠ¤ï¼šæ•°æ®åº“çŠ¶æ€æ£€æŸ¥ + åŸå­æ›´æ–°
        updated = Video.objects.filter(
            id=video_id,
            status__in=['uploading', 'processing', 'transcoding']
        ).exclude(
            hls_file__isnull=False  # æ’é™¤å·²å¤„ç†å®Œæˆçš„
        ).update(status='processing')
        
        if updated == 0:
            logger.warning(f"è§†é¢‘ {video_id} ä¸ç¬¦åˆå¤„ç†æ¡ä»¶ï¼Œè·³è¿‡")
            return {"status": "skipped", "reason": "invalid_state"}
        
        # æ‰§è¡Œè½¬ç å¤„ç†...
        video = Video.objects.get(id=video_id)
        # ... è½¬ç é€»è¾‘ ...
        
        logger.info(f"è§†é¢‘ {video_id} å¤„ç†å®Œæˆ")
        return {"status": "success", "video_id": video_id}
        
    except Exception as e:
        logger.error(f"å¤„ç†è§†é¢‘ {video_id} å¤±è´¥: {str(e)}")
        
        # å¦‚æœè¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼ŒæŠ›å‡ºå¼‚å¸¸è®© Celery é‡è¯•
        if self.request.retries < self.max_retries:
            raise self.retry(exc=e)
        
        return {"status": "error", "reason": str(e)}
    
    finally:
        # æ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½é‡Šæ”¾é”
        release_video_lock(video_id)
        logger.info(f"é‡Šæ”¾è§†é¢‘ {video_id} çš„å¤„ç†é”")
```

### é˜²æŠ¤æœºåˆ¶åˆ†æ

**ä¸ºä»€ä¹ˆéœ€è¦ä¸¤å±‚é˜²æŠ¤ï¼Ÿ**

1. **Redis é”ï¼ˆç¬¬ä¸€å±‚ï¼‰**ï¼š
   - é˜²æ­¢å¤šä¸ª Worker åŒæ—¶å¤„ç†
   - è·¨è¿›ç¨‹ã€è·¨æœåŠ¡å™¨ç”Ÿæ•ˆ
   - å“åº”é€Ÿåº¦å¿«

2. **æ•°æ®åº“çŠ¶æ€æ£€æŸ¥ï¼ˆç¬¬äºŒå±‚ï¼‰**ï¼š
   - é˜²æ­¢é‡å¤æäº¤ä»»åŠ¡
   - ç¡®ä¿ä¸šåŠ¡çŠ¶æ€æ­£ç¡®
   - æŒä¹…åŒ–ä¿è¯

**åŒé‡ä¿é™©çš„å¥½å¤„**ï¼š
- Redis é”å¯èƒ½å› ç½‘ç»œé—®é¢˜å¤±æ•ˆ
- æ•°æ®åº“çŠ¶æ€æ˜¯æœ€ç»ˆçš„çœŸå®çŠ¶æ€
- ä¸¤å±‚ç»“åˆï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±

## å®é™…æ‰§è¡Œæµç¨‹

### åœºæ™¯ 1ï¼šæ­£å¸¸å¤„ç†

```
Worker A: å°è¯•è·å–é” video_id=123
Redis: key ä¸å­˜åœ¨ï¼Œè®¾ç½®æˆåŠŸ âœ…
Worker A: å¼€å§‹å¤„ç†è§†é¢‘ 123
Worker A: è½¬ç ä¸­...
Worker A: å¤„ç†å®Œæˆï¼Œé‡Šæ”¾é”
Redis: åˆ é™¤ key âœ…
```

### åœºæ™¯ 2ï¼šå¹¶å‘å†²çª

```
Worker A: å°è¯•è·å–é” video_id=123
Redis: key ä¸å­˜åœ¨ï¼Œè®¾ç½®æˆåŠŸ âœ…
Worker A: å¼€å§‹å¤„ç†è§†é¢‘ 123

Worker B: å°è¯•è·å–é” video_id=123
Redis: key å·²å­˜åœ¨ï¼Œè®¾ç½®å¤±è´¥ âŒ
Worker B: è·³è¿‡å¤„ç†ï¼Œè¿”å› "already_processing"

Worker A: å¤„ç†å®Œæˆï¼Œé‡Šæ”¾é”
Redis: åˆ é™¤ key âœ…
```

### åœºæ™¯ 3ï¼šWorker å´©æºƒ

```
Worker A: å°è¯•è·å–é” video_id=123
Redis: key ä¸å­˜åœ¨ï¼Œè®¾ç½®æˆåŠŸ âœ…
Worker A: å¼€å§‹å¤„ç†è§†é¢‘ 123
Worker A: å´©æºƒ ğŸ’¥ï¼ˆæœªé‡Šæ”¾é”ï¼‰

... 2å°æ—¶å ...

Redis: key è‡ªåŠ¨è¿‡æœŸ â°
Worker B: å°è¯•è·å–é” video_id=123
Redis: key ä¸å­˜åœ¨ï¼Œè®¾ç½®æˆåŠŸ âœ…
Worker B: å¼€å§‹å¤„ç†è§†é¢‘ 123ï¼ˆé‡æ–°å¤„ç†ï¼‰
```

## é…ç½®è¯´æ˜

### Redis é…ç½®

```python
# settings.py
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': 'redis://localhost:6379/1',  # ä½¿ç”¨ DB 1
        'KEY_PREFIX': 'video_web',
        'TIMEOUT': 3600,
    }
}
```

### é”è¶…æ—¶æ—¶é—´é€‰æ‹©

```python
# è§†é¢‘å¤„ç†é”ï¼š2å°æ—¶
acquire_video_lock(video_id, timeout=7200)
```

**è€ƒè™‘å› ç´ **ï¼š
- è§†é¢‘è½¬ç é€šå¸¸éœ€è¦å‡ åˆ†é’Ÿåˆ°å‡ ååˆ†é’Ÿ
- è®¾ç½® 2 å°æ—¶æ˜¯ä¸ºäº†åº”å¯¹è¶…å¤§è§†é¢‘
- å¦‚æœ Worker å´©æºƒï¼Œæœ€å¤šç­‰å¾… 2 å°æ—¶åé”è‡ªåŠ¨é‡Šæ”¾

## ä¼˜åŠ¿ä¸å±€é™

### ä¼˜åŠ¿

1. **é«˜æ€§èƒ½**ï¼šRedis å†…å­˜æ“ä½œï¼Œå“åº”é€Ÿåº¦å¿«
2. **åˆ†å¸ƒå¼**ï¼šæ”¯æŒå¤šæœåŠ¡å™¨éƒ¨ç½²
3. **è‡ªåŠ¨è¿‡æœŸ**ï¼šé˜²æ­¢æ­»é”
4. **åŸå­æ“ä½œ**ï¼šSETNX ä¿è¯å¹¶å‘å®‰å…¨

### å±€é™

1. **ä¾èµ– Redis**ï¼šRedis æ•…éšœä¼šå½±å“é”æœºåˆ¶
2. **æ—¶é’Ÿä¾èµ–**ï¼šè¶…æ—¶ä¾èµ–æœåŠ¡å™¨æ—¶é’ŸåŒæ­¥
3. **ä¸å¯é‡å…¥**ï¼šåŒä¸€ä¸ª Worker ä¸èƒ½é‡å¤è·å–é”

### æ”¹è¿›æ–¹æ¡ˆ

å¦‚æœéœ€è¦æ›´å¼ºçš„é”æœºåˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ Redlock ç®—æ³•ï¼š
- ä½¿ç”¨å¤šä¸ª Redis å®ä¾‹
- éœ€è¦åœ¨å¤§å¤šæ•°å®ä¾‹ä¸Šè·å–é”æ‰ç®—æˆåŠŸ
- æé«˜å¯é æ€§ï¼Œä½†å¢åŠ å¤æ‚åº¦

## è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹ Redis ä¸­çš„é”

```bash
# è¿æ¥ Redis
redis-cli -n 1

# æŸ¥çœ‹æ‰€æœ‰é”
KEYS video_processing_lock:*

# æŸ¥çœ‹ç‰¹å®šè§†é¢‘çš„é”
GET video_processing_lock:123

# æŸ¥çœ‹é”çš„å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
TTL video_processing_lock:123

# æ‰‹åŠ¨åˆ é™¤é”ï¼ˆè°ƒè¯•ç”¨ï¼‰
DEL video_processing_lock:123
```

### æ—¥å¿—åˆ†æ

```python
logger.info(f"[Task {task_id}] æ”¶åˆ°è§†é¢‘å¤„ç†ä»»åŠ¡: video_id={video_id}")
logger.warning(f"[Task {task_id}] è§†é¢‘ {video_id} æ­£åœ¨è¢«å…¶ä»–ä»»åŠ¡å¤„ç†ï¼ˆRedisé”ï¼‰ï¼Œè·³è¿‡")
logger.info(f"[Task {task_id}] é‡Šæ”¾è§†é¢‘ {video_id} çš„å¤„ç†é”")
```

é€šè¿‡æ—¥å¿—å¯ä»¥è¿½è¸ªï¼š
- ä»»åŠ¡ä½•æ—¶å¼€å§‹
- æ˜¯å¦å› ä¸ºé”è€Œè·³è¿‡
- é”ä½•æ—¶é‡Šæ”¾

## æ€»ç»“

Redis åˆ†å¸ƒå¼é”é€šè¿‡ SETNX åŸå­æ“ä½œï¼Œå®ç°äº†è·¨è¿›ç¨‹ã€è·¨æœåŠ¡å™¨çš„äº’æ–¥è®¿é—®æ§åˆ¶ã€‚åœ¨è§†é¢‘è½¬ç åœºæ™¯ä¸­ï¼Œé…åˆæ•°æ®åº“çŠ¶æ€æ£€æŸ¥ï¼Œå½¢æˆåŒé‡é˜²æŠ¤æœºåˆ¶ï¼Œæœ‰æ•ˆé˜²æ­¢äº†èµ„æºæµªè´¹å’Œæ•°æ®å†²çªã€‚

**æ ¸å¿ƒè¦ç‚¹**ï¼š
- ä½¿ç”¨ `cache.add()` è·å–é”ï¼ˆSETNXï¼‰
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´é˜²æ­¢æ­»é”
- ä½¿ç”¨ `try...finally` ç¡®ä¿é”è¢«é‡Šæ”¾
- ç»“åˆæ•°æ®åº“çŠ¶æ€æ£€æŸ¥å½¢æˆåŒé‡ä¿é™©
